// Prisma schema for multi-tenant SaaS ticketing tool

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum TicketStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MessageSource {
  visitor
  slack
  discord
}

enum WebhookDeliveryStatus {
  pending
  success
  failed
}

enum SubscriptionStatus {
  incomplete
  incomplete_expired
  trialing
  active
  past_due
  canceled
  unpaid
  paused
}

// Account - The SaaS customer organization
model Account {
  id             String   @id @default(cuid())
  name           String
  allowedDomains String[] // Widget embed domains
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users                 User[]
  slackInstallation     SlackInstallation?
  slackChannelConfigs   SlackChannelConfig[]
  discordInstallation   DiscordInstallation?
  discordChannelConfigs DiscordChannelConfig[]
  tickets               Ticket[]
  visitors              Visitor[]
  webhookEndpoints      WebhookEndpoint[]
  widgetConfig          WidgetConfig?
  subscription          Subscription?

  @@map("accounts")
}

// User - Dashboard user belonging to an Account
model User {
  id            String   @id @default(cuid())
  accountId     String?  // Made optional for OAuth flows
  email         String   @unique
  name          String?
  emailVerified Boolean  @default(false)
  image         String?
  password      String?  @map("passwordHash") // Mapped to existing column
  role          String   @default("member") // admin, member
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  account       Account?      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  sessions      Session[]
  authAccounts  AuthAccount[]

  @@index([accountId])
  @@map("users")
}

// Session - User sessions for authentication
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("sessions")
}

// AuthAccount - OAuth accounts for Better Auth
model AuthAccount {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String    // Provider's account ID
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("auth_accounts")
}

// Verification - For email verification etc.
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// SlackInstallation - Stores Slack OAuth tokens for an Account
model SlackInstallation {
  id                  String   @id @default(cuid())
  accountId           String   @unique
  slackTeamId         String
  slackTeamName       String
  botAccessToken      String   // Encrypted at rest
  refreshToken        String?  // Encrypted, for token rotation
  tokenExpiresAt      DateTime?
  botUserId           String
  scopes              String[]
  installedAt         DateTime @default(now())
  updatedAt           DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([slackTeamId])
  @@map("slack_installations")
}

// SlackChannelConfig - Channels where tickets appear
model SlackChannelConfig {
  id               String   @id @default(cuid())
  accountId        String
  slackChannelId   String
  slackChannelName String
  isDefault        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, slackChannelId])
  @@index([accountId])
  @@map("slack_channel_configs")
}

// DiscordInstallation - Stores Discord bot tokens for an Account
model DiscordInstallation {
  id               String   @id @default(cuid())
  accountId        String   @unique
  discordGuildId   String   // Discord server ID
  discordGuildName String
  botAccessToken   String   // Encrypted at rest
  botUserId        String   // Bot's user ID in Discord
  installedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([discordGuildId])
  @@map("discord_installations")
}

// DiscordChannelConfig - Channels where tickets appear in Discord
model DiscordChannelConfig {
  id                 String   @id @default(cuid())
  accountId          String
  discordChannelId   String   // Channel ID
  discordChannelName String
  isDefault          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, discordChannelId])
  @@index([accountId])
  @@map("discord_channel_configs")
}

// WidgetConfig - Theming and settings for the widget
model WidgetConfig {
  id              String   @id @default(cuid())
  accountId       String   @unique
  primaryColor    String   @default("#4A154B")
  accentColor     String   @default("#1264A3")
  greetingText    String   @default("Hi! How can we help you today?")
  companyName     String?
  controlledByHost Boolean @default(false)
  officeHoursStart String?  // e.g., "09:00"
  officeHoursEnd   String?  // e.g., "17:00"
  officeHoursTimezone String? @default("UTC")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("widget_configs")
}

// Visitor - Anonymous or identified website visitor
model Visitor {
  id          String   @id @default(cuid())
  accountId   String
  anonymousId String   // Client-generated unique ID
  email       String?
  name        String?
  metadata    Json?    // Custom key-value store from widget
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  account Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  tickets Ticket[]

  @@unique([accountId, anonymousId])
  @@index([accountId])
  @@map("visitors")
}

// Ticket - Support ticket with Slack/Discord thread mapping
model Ticket {
  id                  String         @id @default(cuid())
  accountId           String
  status              TicketStatus   @default(OPEN)
  priority            TicketPriority @default(MEDIUM)
  subject             String?
  visitorId           String
  assignedUserId      String?
  // Slack thread mapping
  slackChannelId      String?
  slackThreadTs       String?        // Thread timestamp for matching replies
  slackRootMessageTs  String?
  slackPermalink      String?
  // Discord thread mapping
  discordChannelId    String?        // Channel where ticket lives
  discordThreadId     String?        // Thread ID for matching replies
  discordMessageId    String?        // Initial message ID in thread
  discordPermalink    String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  visitor  Visitor   @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  messages Message[]
  webhookDeliveries WebhookDelivery[]

  @@index([accountId, status])
  @@index([accountId, slackThreadTs])
  @@index([slackChannelId, slackThreadTs])
  @@index([accountId, discordThreadId])
  @@index([discordChannelId, discordThreadId])
  @@index([visitorId])
  @@map("tickets")
}

// Message - Individual messages in a ticket thread
model Message {
  id              String        @id @default(cuid())
  ticketId        String
  source          MessageSource
  text            String
  // Slack message info
  slackTs         String?       // Slack message timestamp
  slackUserId     String?       // Slack user who sent the message
  slackUserName   String?       // Display name from Slack
  rawSlackEvent   Json?         // Raw Slack event for debugging
  // Discord message info
  discordMessageId String?      // Discord message ID
  discordUserId    String?      // Discord user who sent the message
  discordUserName  String?      // Display name from Discord
  rawDiscordEvent  Json?        // Raw Discord event for debugging
  createdAt       DateTime      @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  webhookDeliveries WebhookDelivery[]

  @@index([ticketId, createdAt])
  @@index([slackTs])
  @@index([discordMessageId])
  @@map("messages")
}

// WebhookEndpoint - Customer-configured webhook URLs
model WebhookEndpoint {
  id        String   @id @default(cuid())
  accountId String
  url       String
  secret    String   // HMAC signing secret
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  account   Account           @relation(fields: [accountId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@index([accountId])
  @@map("webhook_endpoints")
}

// WebhookDelivery - Tracks webhook delivery attempts
model WebhookDelivery {
  id              String                @id @default(cuid())
  endpointId      String
  ticketId        String
  messageId       String?
  idempotencyKey  String                @unique
  payload         Json
  attemptCount    Int                   @default(0)
  lastAttemptAt   DateTime?
  nextAttemptAt   DateTime?
  status          WebhookDeliveryStatus @default(pending)
  lastError       String?
  lastStatusCode  Int?
  createdAt       DateTime              @default(now())

  endpoint WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  ticket   Ticket          @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  message  Message?        @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([endpointId, status])
  @@index([nextAttemptAt])
  @@map("webhook_deliveries")
}

// EventDedup - Prevents duplicate Slack/Discord event processing
model EventDedup {
  id             String   @id @default(cuid())
  // Slack event deduplication
  slackEventId   String?
  slackTeamId    String?
  // Discord event deduplication
  discordEventId String?
  discordGuildId String?
  processedAt    DateTime @default(now())

  @@unique([slackTeamId, slackEventId])
  @@unique([discordGuildId, discordEventId])
  @@index([processedAt])
  @@map("event_dedups")
}

// OAuthState - Temporary state storage for OAuth flows
model OAuthState {
  id        String   @id @default(cuid())
  state     String   @unique
  accountId String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("oauth_states")
}

// Subscription - Stripe subscription for an Account
model Subscription {
  id                   String             @id @default(cuid())
  accountId            String             @unique
  stripeCustomerId     String             @unique
  stripeSubscriptionId String?            @unique
  stripePriceId        String?
  stripeProductId      String?
  status               SubscriptionStatus @default(incomplete)
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}
